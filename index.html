<!DOCTYPE html>
<html>
<head>
  <title>Binance Spot BTC/USDT Order Book</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Binance Spot BTC/USDT Order Book</h1>
  <div id="order-book-data">
    <h2>Order Book Data</h2>
    <p>Best Bid: <span id="best-bid"></span></p>
    <p>Best Ask: <span id="best-ask"></span></p>
    <p>Bid/Ask Ratio (Top 5% Depth): <span id="bid-ask-ratio"></span></p>
  </div>

  <div id="charts">
    <h2>Order Book Depth Chart (Top 5%)</h2>
    <canvas id="depth-chart"></canvas>
  </div>

  <script>
    async function fetchOrderBook() {
      try {
        const response = await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=100');
        const data = await response.json();

        const bids = data.bids.map(item => parseFloat(item[0]));
        const bidVolumes = data.bids.map(item => parseFloat(item[1]));
        const asks = data.asks.map(item => parseFloat(item[0]));
        const askVolumes = data.asks.map(item => parseFloat(item[1]));

        const bestBid = bids[0];
        const bestAsk = asks[0];

        // Calculate mid price
        const midPrice = (bestBid + bestAsk) / 2;

        // Calculate order book depth at 5% of mid price
        const depthPercentage = 0.05; 
        let bidDepth5 = 0;
        let askDepth5 = 0;

        for (let i = 0; i < bids.length; i++) {
          if (bids[i][0] >= midPrice * (1 - depthPercentage)) {
            bidDepth5 += bids[i][1];
          } else {
            break; 
          }
        }

        for (let i = 0; i < asks.length; i++) {
          if (asks[i][0] <= asks[0][0] + (midPrice * depthPercentage)) { 
            askDepth5 += asks[i][1];
          } else {
            break; 
          }
        }

        // Calculate Bid/Ask Ratio 
        let bidAskRatio;
        if (askDepth5 === 0) {
          bidAskRatio = Infinity; 
        } else if (bidDepth5 === 0) {
          bidAskRatio = 0;
        } else {
          bidAskRatio = bidDepth5 / askDepth5;
        }

        // Update UI
        document.getElementById('best-bid').textContent = bestBid;
        document.getElementById('best-ask').textContent = bestAsk;
        document.getElementById('bid-ask-ratio').textContent = bidAskRatio.toFixed(2);

        // Create Chart.js chart
        const ctx = document.getElementById('depth-chart').getContext('2d');
        const chartData = {
          labels: ['Bid Depth (Top 5%)', 'Ask Depth (Top 5%)'],
          datasets: [{
            label: 'Depth',
            data: [bidDepth5, askDepth5],
            backgroundColor: ['green', 'red']
          }]
        };

        if (chart) {
          chart.data = chartData; 
          chart.update();
        } else {
          chart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }

      } catch (error) {
        console.error("Error fetching order book:", error);
        document.getElementById('best-bid').textContent = "N/A";
        document.getElementById('best-ask').textContent = "N/A";
        document.getElementById('bid-ask-ratio').textContent = "N/A";
      }
    }

    // Fetch initial data
    fetchOrderBook();

    // Optional: Periodically refresh data (e.g., every second)
    setInterval(fetchOrderBook, 1000); 

  </script>
</body>
</html>
