<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/USDT Depth Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }
        h1, select {
            margin: 10px 0;
        }
        canvas {
            max-width: 90%;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>BTC/USDT Depth Analysis</h1>
    <label for="timeframe">Select Time Frame:</label>
    <select id="timeframe">
        <option value="5m">5 Minutes</option>
        <option value="15m">15 Minutes</option>
        <option value="1h">1 Hour</option>
        <option value="4h">4 Hours</option>
        <option value="1d">1 Day</option>
        <option value="1w" selected>1 Week</option>
    </select>
    <canvas id="priceChart"></canvas>
    <canvas id="depthChart"></canvas>

    <script>
        const symbol = "BTCUSDT";
        let priceChart, depthChart;

        async function fetchKlineData(interval, limit) {
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
            const response = await fetch(url);
            const data = await response.json();
            const timestamps = [], prices = [];
            data.forEach(kline => {
                timestamps.push(new Date(kline[0]).toLocaleString());
                prices.push(parseFloat(kline[4])); // Close price
            });
            return { timestamps, prices };
        }

        async function fetchHistoricalDepthData(interval, limit) {
            // Simulated depth data for demonstration
            // Replace this with real historical depth data retrieval logic
            const timestamps = [];
            const bids = [];
            const asks = [];
            const now = Date.now();

            for (let i = 0; i < limit; i++) {
                timestamps.push(new Date(now - i * interval).toLocaleString());
                bids.push(Math.random() * 100000 + 50000); // Random values for demonstration
                asks.push(Math.random() * 100000 + 50000);
            }
            timestamps.reverse();
            bids.reverse();
            asks.reverse();
            return { timestamps, bids, asks };
        }

        async function updateCharts(interval, limit) {
            try {
                const { timestamps: priceTimestamps, prices } = await fetchKlineData(interval, limit);
                const { timestamps: depthTimestamps, bids, asks } = await fetchHistoricalDepthData(interval, limit);

                // Update Price Chart
                priceChart.data.labels = priceTimestamps;
                priceChart.data.datasets[0].data = prices;
                priceChart.update();

                // Update Depth Chart
                depthChart.data.labels = depthTimestamps;
                depthChart.data.datasets[0].data = bids;
                depthChart.data.datasets[1].data = asks;
                depthChart.update();
            } catch (error) {
                console.error("Error updating charts:", error);
            }
        }

        function initializeCharts() {
            const priceCtx = document.getElementById("priceChart").getContext("2d");
            const depthCtx = document.getElementById("depthChart").getContext("2d");

            // BTC Price Chart
            priceChart = new Chart(priceCtx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "BTC/USDT Price",
                        data: [],
                        borderColor: "#4caf50",
                        borderWidth: 2,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Price (USDT)" } }
                    }
                }
            });

            // Depth Chart
            depthChart = new Chart(depthCtx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: "Top 10% Bids Sum",
                            data: [],
                            borderColor: "#4caf50",
                            borderWidth: 2,
                            fill: false,
                        },
                        {
                            label: "Top 10% Asks Sum",
                            data: [],
                            borderColor: "#f44336",
                            borderWidth: 2,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Sum (USDT)" } }
                    }
                }
            });
        }

        // Event listener for the timeframe selector
        document.getElementById("timeframe").addEventListener("change", (event) => {
            const value = event.target.value;
            let interval, limit;

            switch (value) {
                case "5m": interval = 5 * 60 * 1000; limit = 12; break;  // Last 1 hour, 12 points
                case "15m": interval = 15 * 60 * 1000; limit = 96; break; // Last 1 day, 96 points
                case "1h": interval = 60 * 60 * 1000; limit = 168; break; // Last 1 week, 168 points
                case "4h": interval = 4 * 60 * 60 * 1000; limit = 42; break; // Last 1 week, 42 points
                case "1d": interval = 24 * 60 * 60 * 1000; limit = 7; break; // Last 1 week, 7 points
                case "1w": interval = 24 * 60 * 60 * 1000; limit = 7; break; // Last 1 week, 7 points
                default: interval = 60 * 60 * 1000; limit = 168; break;
            }

            updateCharts(interval, limit);
        });

        initializeCharts();
        updateCharts(60 * 60 * 1000, 168); // Default: Last 1 week, hourly points
    </script>
</body>
</html>