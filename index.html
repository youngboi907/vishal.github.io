<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTCUSDT Order Book & OI/Volume Ratio</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <style>
        body {
            background-color: #1f1f1f;
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #f0f0f0;
            font-size: 2.5em;
            text-align: center;
            margin-top: 30px;
            font-weight: bold;
        }

        #order-book-section, #oi-volume-ratio-section {
            width: 90%;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background-color: #2a2a2a;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #order-book-chart {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #oi-volume-ratio {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            font-size: 1.2em;
        }

        .info-card {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 45%;
            margin-top: 15px;
        }

        .info-card p {
            margin: 10px 0;
        }

        .highlight-text {
            font-weight: bold;
            color: #00d4b7;
        }

        .error {
            color: #ff4e42;
            font-weight: bold;
        }

        .footer {
            margin-top: 50px;
            color: #bbb;
            text-align: center;
        }

        .footer a {
            color: #00d4b7;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .loading {
            font-size: 1.5em;
            color: #ff9900;
        }
    </style>
</head>
<body>

    <h1>BTCUSDT Order Book & OI/Volume Ratio</h1>

    <div id="order-book-section">
        <h2>BTCUSDT Order Book (0% to 10% around Mid-Price)</h2>
        <div id="order-book-chart"></div>
    </div>

    <div id="oi-volume-ratio-section">
        <h2>OI/Volume Ratio</h2>
        <div class="info-card">
            <p>OI/Volume Ratio: <span id="oiVolumeRatio" class="highlight-text">Loading...</span></p>
        </div>
    </div>

    <div class="footer">
        <p>Data provided by <a href="https://www.binance.com" target="_blank">Binance</a></p>
    </div>

    <script>
        // --- Order Book Section ---
        async function fetchOrderBook() {
            try {
                const response = await axios.get('https://api.binance.com/api/v3/depth', {
                    params: {
                        symbol: 'BTCUSDT',
                        limit: 1000 // Increase limit for better 0-10% coverage
                    }
                });

                const bids = response.data.bids.map(([price, qty]) => [parseFloat(price), parseFloat(qty)]);
                const asks = response.data.asks.map(([price, qty]) => [parseFloat(price), parseFloat(qty)]);
                
                return { bids, asks };
            } catch (error) {
                console.error("Error fetching order book data:", error);
                return { bids: [], asks: [] }; 
            }
        }

        function filterOrderBook(bids, asks, mid_price) {
            const lower_bound = mid_price * 0.90;
            const upper_bound = mid_price * 1.10;

            const filtered_bids = bids.filter(([price, _]) => price >= lower_bound && price <= upper_bound);
            const filtered_asks = asks.filter(([price, _]) => price >= lower_bound && price <= upper_bound);

            return { filtered_bids, filtered_asks };
        }

        function createOrderBookChart(filtered_bids, filtered_asks) {
            const bid_prices = filtered_bids.map(([price, _]) => price);
            const bid_quantities = filtered_bids.map(([_, qty]) => qty);
            const ask_prices = filtered_asks.map(([price, _]) => price);
            const ask_quantities = filtered_asks.map(([_, qty]) => qty);

            const trace1 = {
                x: bid_prices,
                y: bid_quantities,
                type: 'bar',
                name: 'Bids',
                marker: { color: '#00d4b7' }
            };

            const trace2 = {
                x: ask_prices,
                y: ask_quantities,
                type: 'bar',
                name: 'Asks',
                marker: { color: '#ff4e42' }
            };

            const data = [trace1, trace2];

            const layout = {
                title: 'BTCUSDT Order Book (0% to 10% around Mid-Price)',
                xaxis: { title: 'Price' },
                yaxis: { title: 'Order Quantity' },
                barmode: 'group',
                plot_bgcolor: '#1f1f1f',
                paper_bgcolor: '#1f1f1f',
                font: { color: '#fff' }
            };

            Plotly.newPlot('order-book-chart', data, layout);
        }

        async function updateOrderBook() {
            const orderBookData = await fetchOrderBook();

            if (orderBookData.bids.length === 0 || orderBookData.asks.length === 0) {
                console.error("No order book data received.");
                return; 
            }

            const mid_price = (orderBookData.bids[0][0] + orderBookData.asks[0][0]) / 2;
            const { filtered_bids, filtered_asks } = filterOrderBook(orderBookData.bids, orderBookData.asks, mid_price);

            createOrderBookChart(filtered_bids, filtered_asks);
        }

        // --- OI/Volume Ratio Section ---
        async function fetchMarketData() {
            try {
                const [tickerResponse, openInterestResponse] = await Promise.all([
                    axios.get('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT'),
                    axios.get('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT')
                ]);

                const volume = parseFloat(tickerResponse.data.volume);
                const openInterest = parseFloat(openInterestResponse.data.openInterest);

                return { volume, openInterest };
            } catch (error) {
                console.error("Error fetching market data:", error);
                return { volume: 0, openInterest: 0 };
            }
        }

        function calculateOIVolumeRatio(volume, openInterest) {
            if (volume === 0 || openInterest === 0) {
                return 0;
            }
            return openInterest / volume;
        }

        function displayOIVolumeRatio(ratio) {
            document.getElementById('oiVolumeRatio').textContent = ratio.toFixed(2);
        }

        async function updateMarketData() {
            const { volume, openInterest } = await fetchMarketData();
            const ratio = calculateOIVolumeRatio(volume, openInterest);
            displayOIVolumeRatio(ratio);
        }

        // --- Update Intervals ---
        setInterval(updateOrderBook, 5000); // Update order book every 5 seconds
        setInterval(updateMarketData, 2000); // Update OI/Volume Ratio every 2 seconds

        // Initial fetches
        updateOrderBook();
        updateMarketData();
    </script>

</body>
</html>