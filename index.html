<!DOCTYPE html>
<html>
<head>
    <title>BTCUSDT Order Book Depth Sums (0% to 10% around Mid-Price)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>BTCUSDT Order Book Depth Sums (0% to 10% around Mid-Price)</h1>
    <div id="chart"></div>

    <script>
        async function fetchOrderBook() {
            try {
                const response = await axios.get('https://api.binance.com/api/v3/depth', {
                    params: {
                        symbol: 'BTCUSDT',
                        limit: 1000 // Increase limit for better 0-10% coverage
                    }
                });

                const bids = response.data.bids.map(([price, qty]) => [parseFloat(price), parseFloat(qty)]);
                const asks = response.data.asks.map(([price, qty]) => [parseFloat(price), parseFloat(qty)]);
                
                return { bids, asks };
            } catch (error) {
                console.error("Error fetching order book data:", error);
                return { bids:, asks: }; // Return empty arrays on error
            }
        }

        function calculateDepthSums(bids, asks, mid_price) {
            const ranges = [
                { lower: mid_price * 0.90, upper: mid_price * 1.10, label: '0-10%' },
            ];

            const results = {};

            for (const range of ranges) {
                const { lower, upper, label } = range;
                const filtered_bids = bids.filter(([price, _]) => price >= lower && price <= upper);
                const filtered_asks = asks.filter(([price, _]) => price >= lower && price <= upper);

                const bid_sum = filtered_bids.reduce((acc, curr) => acc + curr[1], 0);
                const ask_sum = filtered_asks.reduce((acc, curr) => acc + curr[1], 0);
                const delta = ask_sum - bid_sum;

                results[label] = { bid_sum, ask_sum, delta };
            }

            return results;
        }

        function createChart(results) {
            const labels = Object.keys(results);
            const bid_sums = Object.values(results).map(obj => obj.bid_sum);
            const ask_sums = Object.values(results).map(obj => obj.ask_sum);

            const data = [
                {
                    x: labels,
                    y: bid_sums,
                    name: 'Bids',
                    type: 'bar',
                    marker: { color: 'green' }
                },
                {
                    x: labels,
                    y: ask_sums,
                    name: 'Asks',
                    type: 'bar',
                    marker: { color: 'red' }
                }
            ];

            const layout = {
                title: 'BTCUSDT Order Book Depth Sums (0% to 10% around Mid-Price)',
                xaxis: { title: 'Price Range' },
                yaxis: { title: 'Order Quantity Sum' },
                barmode: 'group', 
                plot_bgcolor: '#121212', 
                paper_bgcolor: '#121212', 
                font: { color: '#fff' } 
            };

            Plotly.newPlot('chart', data, layout);
        }

        async function updateOrderBookData() {
            const orderBookData = await fetchOrderBook();

            const mid_price = (orderBookData.bids[0][0] + orderBookData.asks[0][0]) / 2;
            const results = calculateDepthSums(orderBookData.bids, orderBookData.asks, mid_price);

            createChart(results); 

            // Display results (you can customize this part)
            for (const range in results) {
                const bidSumId = `bidSum${range}`;
                const askSumId = `askSum${range}`;
                const deltaId = `delta${range}`;

                document.getElementById(bidSumId).textContent = results[range].bid_sum;
                document.getElementById(askSumId).textContent = results[range].ask_sum;
                document.getElementById(deltaId).textContent = results[range].delta;
            }
        }

        // Update the order book data every 5 seconds
        setInterval(updateOrderBookData, 5000);

        // Initial fetch and render
        updateOrderBookData();
    </script>

</body>
</html>
