<!DOCTYPE html>
<html>
<head>
    <title>BTCUSDT OI/Volume Ratio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            margin-top: 20px;
            font-size: 2rem;
        }
        #ratio {
            text-align: center;
            font-size: 1.5rem;
            margin-top: 20px;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <h1>BTCUSDT OI/Volume Ratio</h1>
    <div id="ratio"></div>
    <canvas id="ratioChart"></canvas>

    <script>
        const chartData = {
            labels: [],
            datasets: [{
                label: 'OI/Volume Ratio',
                data: [],
                fill: true,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        const config = {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'BTCUSDT OI/Volume Ratio'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (UTC)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'OI/Volume Ratio'
                        }
                    }
                }
            }
        };

        const ctx = document.getElementById('ratioChart').getContext('2d');
        const myChart = new Chart(ctx, config);

        let lastFetchTime = 0;

        async function getRatio() {
            try {
                const currentTime = Math.floor(Date.now() / 1000);
                
                // Fetch data only if 5 minutes have passed since the last fetch
                if (currentTime - lastFetchTime >= 300) { 
                    const response = await axios.get('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT'); 
                    const volume = parseFloat(response.data.volume); 
                    const openInterest = await getOpenInterest(); 

                    const ratio = openInterest / volume;
                    document.getElementById('ratio').textContent = `OI/Volume Ratio: ${ratio.toFixed(2)}`;

                    // Update chart data
                    chartData.labels.push(new Date().toLocaleTimeString()); 
                    chartData.datasets[0].data.push(ratio);

                    // Limit data points to the last 12 (for 1 hour window)
                    if (chartData.labels.length > 12) {
                        chartData.labels.shift();
                        chartData.datasets[0].data.shift();
                    }

                    myChart.update();
                    lastFetchTime = currentTime;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('ratio').textContent = 'Error fetching data.';
            }
        }

        async function getOpenInterest() {
            try {
                const response = await axios.get('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');
                return parseFloat(response.data.openInterest);
            } catch (error) {
                console.error('Error fetching open interest:', error);
                return 0;
            }
        }

        // Update ratio and chart every second (but fetch new data every 5 minutes)
        setInterval(getRatio, 1000); 

        // Initial fetch
        getRatio();
    </script>

</body>
</html>