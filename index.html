<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top N Orders by Volume - BTC/USDT Order Book</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }
        h1, select {
            margin: 10px 0;
        }
        canvas {
            max-width: 95%;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Top N Orders by Volume in BTC/USDT Order Book</h1>
    <label for="topNSelector">Select Top N:</label>
    <select id="topNSelector">
        <option value="5">Top 5</option>
        <option value="10" selected>Top 10</option>
        <option value="20">Top 20</option>
        <option value="30">Top 30</option>
    </select>
    <canvas id="orderBookChart"></canvas>

    <script>
        const symbol = "BTCUSDT";
        let topN = 10; // Default to Top 10 orders
        let orderBook = { bids: [], asks: [] }; // Order book data
        let orderBookChart;

        // Function to fetch the order book data from Binance API
        async function fetchOrderBook() {
            const response = await fetch(`https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=1000`);
            const data = await response.json();
            processOrderBookData(data);
        }

        // Function to process order book data and ensure 10% price range
        function processOrderBookData(data) {
            const midPrice = (parseFloat(data.bids[0][0]) + parseFloat(data.asks[0][0])) / 2;
            const priceRange = {
                min: midPrice * 0.9, // 10% below the mid price
                max: midPrice * 1.1  // 10% above the mid price
            };

            // Filter bids and asks within the 10% price range
            const filteredBids = data.bids
                .map(([price, quantity]) => ({ price: parseFloat(price), quantity: parseFloat(quantity) }))
                .filter(order => order.price >= priceRange.min)
                .sort((a, b) => b.quantity * b.price - a.quantity * a.price); // Sort by volume

            const filteredAsks = data.asks
                .map(([price, quantity]) => ({ price: parseFloat(price), quantity: parseFloat(quantity) }))
                .filter(order => order.price <= priceRange.max)
                .sort((a, b) => b.quantity * b.price - a.quantity * a.price); // Sort by volume

            // Limit to top N orders
            orderBook.bids = filteredBids.slice(0, topN);
            orderBook.asks = filteredAsks.slice(0, topN);

            updateChart();
        }

        // Initialize the chart
        function initializeChart() {
            const ctx = document.getElementById("orderBookChart").getContext("2d");

            orderBookChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [], // Will be updated dynamically
                    datasets: [
                        {
                            label: "Bids",
                            data: [],
                            backgroundColor: "rgba(76, 175, 80, 0.7)", // Green
                        },
                        {
                            label: "Asks",
                            data: [],
                            backgroundColor: "rgba(244, 67, 54, 0.7)", // Red
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Price Levels (USDT)" },
                            beginAtZero: false
                        },
                        y: {
                            title: { display: true, text: "Volume (BTC)" }
                        }
                    }
                }
            });
        }

        // Update the chart with new order book data
        function updateChart() {
            const bidLabels = orderBook.bids.map(order => `$${order.price.toFixed(2)}`);
            const askLabels = orderBook.asks.map(order => `$${order.price.toFixed(2)}`);

            const bidVolumes = orderBook.bids.map(order => order.quantity * order.price); // Volume = quantity * price
            const askVolumes = orderBook.asks.map(order => order.quantity * order.price); // Volume = quantity * price

            orderBookChart.data.labels = [...bidLabels, ...askLabels];
            orderBookChart.data.datasets[0].data = bidVolumes;
            orderBookChart.data.datasets[1].data = askVolumes;

            orderBookChart.update();
        }

        // Event listener for the top N selector
        document.getElementById("topNSelector").addEventListener("change", (event) => {
            topN = parseInt(event.target.value, 10);
            fetchOrderBook(); // Re-fetch the order book with the new top N value
        });

        // Fetch the initial order book data
        fetchOrderBook();

        // Initialize the chart
        initializeChart();
    </script>
</body>
</html>