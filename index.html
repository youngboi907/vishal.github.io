const fetch = require("node-fetch");

// Fetch trade data from multiple exchanges
async function fetchTradeData(exchange) {
    let url = '';
    switch (exchange) {
        case 'binance':
            url = 'https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=500';
            break;
        case 'bybit':
            url = 'https://api.bybit.com/v2/public/trading-records?symbol=BTCUSDT&limit=500';
            break;
        case 'kraken':
            url = 'https://api.kraken.com/0/public/Trades?pair=XBTUSDT';
            break;
        case 'bitstamp':
            url = 'https://www.bitstamp.net/api/v2/transactions/btcusd/';
            break;
        default:
            throw new Error("Unsupported exchange");
    }

    const response = await fetch(url);
    if (!response.ok) throw new Error(`Failed to fetch data from ${exchange}`);
    return await response.json();
}

// Calculate volume delta
function calculateDelta(tradeData, exchange) {
    let buyVolume = 0;
    let sellVolume = 0;

    if (exchange === 'binance' || exchange === 'bybit') {
        for (const trade of tradeData) {
            if (trade.isBuyerMaker === false) {
                buyVolume += parseFloat(trade.qty);
            } else {
                sellVolume += parseFloat(trade.qty);
            }
        }
    } else if (exchange === 'kraken') {
        for (const [price, volume, side] of tradeData.result.XXBTZUSD) {
            if (side === "b") {
                buyVolume += parseFloat(volume);
            } else {
                sellVolume += parseFloat(volume);
            }
        }
    } else if (exchange === 'bitstamp') {
        for (const trade of tradeData) {
            if (trade.type === "0") {
                buyVolume += parseFloat(trade.amount);
            } else {
                sellVolume += parseFloat(trade.amount);
            }
        }
    }

    return buyVolume - sellVolume;
}

// Aggregate delta across exchanges
async function aggregateVolumeDelta() {
    const exchanges = ['binance', 'bybit', 'kraken', 'bitstamp'];
    let totalDelta = 0;

    for (const exchange of exchanges) {
        try {
            const tradeData = await fetchTradeData(exchange);
            const delta = calculateDelta(tradeData, exchange);
            console.log(`${exchange}: Volume Delta = ${delta}`);
            totalDelta += delta;
        } catch (error) {
            console.error(`Error fetching or processing data for ${exchange}:`, error);
        }
    }

    console.log(`Aggregated Volume Delta: ${totalDelta}`);
    return totalDelta;
}

// Execute
aggregateVolumeDelta();