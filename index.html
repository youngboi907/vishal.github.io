<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Chart with Liquidation Data</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
        }
        #tv_chart_container {
            width: 100%;
            height: 70vh; /* 70% of the viewport for the TradingView chart */
        }
        #liquidation-data {
            width: 100%;
            height: 30vh; /* 30% of the viewport for liquidation data */
            background-color: #1e1e1e;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }
        #liquidation-data table {
            width: 100%;
            border-collapse: collapse;
        }
        #liquidation-data th, #liquidation-data td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        #liquidation-data th {
            background-color: #333;
        }
        #liquidation-data td {
            color: #f0a500;
        }
    </style>
</head>
<body>

<!-- TradingView Chart Container -->
<div id="tv_chart_container"></div>

<!-- Liquidation Data Section -->
<div id="liquidation-data">
    <h3>Liquidation Data</h3>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Price (USDT)</th>
                <th>Quantity</th>
                <th>Side</th>
            </tr>
        </thead>
        <tbody id="liquidation-rows">
            <!-- Dynamic rows will be inserted here -->
        </tbody>
    </table>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    // Initialize TradingView Chart
    const tradingViewWidget = new TradingView.widget({
        container_id: "tv_chart_container",
        autosize: true,
        symbol: "BINANCE:BTCUSDT",
        interval: "60", // 1-hour timeframe
        timezone: "Etc/UTC",
        theme: "dark",
        locale: "en",
        toolbar_bg: "#f1f3f6",
        enable_publishing: false,
        allow_symbol_change: true,
        studies: ["RSI@tv-basicstudies", "MACD@tv-basicstudies", "MAExp@tv-basicstudies"],
        details: true,
        hotlist: true,
        calendar: true,
        withdateranges: true,
    });

    // Fetch Liquidation Data from Binance Futures API
    async function fetchLiquidationData(startTime, endTime) {
        try {
            const response = await fetch(`https://fapi.binance.com/fapi/v1/allForceOrders`);
            const data = await response.json();

            // Filter data for BTCUSDT symbol within the timeframe
            return data.filter(order =>
                order.symbol === "BTCUSDT" &&
                new Date(order.time) >= new Date(startTime) &&
                new Date(order.time) <= new Date(endTime)
            );
        } catch (error) {
            console.error("Error fetching liquidation data:", error);
            return [];
        }
    }

    // Display Liquidation Data in the Table
    function displayLiquidationData(data) {
        const tableBody = document.getElementById("liquidation-rows");
        tableBody.innerHTML = ""; // Clear existing rows

        data.forEach(order => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${new Date(order.time).toLocaleString()}</td>
                <td>${parseFloat(order.price).toFixed(2)}</td>
                <td>${parseFloat(order.qty).toFixed(4)}</td>
                <td style="color: ${order.side === "SELL" ? "red" : "green"};">
                    ${order.side === "SELL" ? "Sell" : "Buy"}
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Sync Liquidation Data with TradingView Timeframe
    tradingViewWidget.onChartReady(() => {
        const intervalToMilliseconds = {
            "1": 60000, // 1 minute
            "5": 300000, // 5 minutes
            "15": 900000, // 15 minutes
            "30": 1800000, // 30 minutes
            "60": 3600000, // 1 hour
            "240": 14400000, // 4 hours
            "D": 86400000, // 1 day
        };

        async function updateLiquidationData() {
            const currentSymbol = "BTCUSDT"; // Current symbol (adjust if needed)
            const interval = tradingViewWidget.interval(); // Get the current interval
            const endTime = new Date().getTime(); // Current time
            const startTime = endTime - (intervalToMilliseconds[interval] || 3600000); // Calculate start time

            const liquidationData = await fetchLiquidationData(startTime, endTime);
            displayLiquidationData(liquidationData);
        }

        // Update liquidation data initially and on interval change
        updateLiquidationData();
        tradingViewWidget.onIntervalChange(updateLiquidationData);
    });
</script>

</body>
</html>