<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Chart with Liquidation Levels</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #121212;
            font-family: Arial, sans-serif;
        }

        #tv_chart_container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80vh; /* TradingView chart occupies 80% of the screen height */
        }

        #liquidationLevelsBox {
            position: absolute;
            top: 80vh;
            left: 0;
            width: 100%;
            height: 20vh; /* Liquidation levels box occupies 20% of the screen height */
            background-color: #2a2a2a;
            color: #fff;
            padding: 10px;
            overflow-y: scroll; /* Allows scrolling if there are many liquidation levels */
        }

        #liquidationLevelsBox h3 {
            margin-top: 0;
        }

        .liquidationLevel {
            background-color: #444;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .liquidationLevel p {
            margin: 5px 0;
        }

        .liquidationLevel .price {
            font-size: 18px;
            color: #FF0000; /* Red for liquidation price */
        }

        .liquidationLevel .leverage {
            color: #00FF00; /* Green for leverage levels */
        }
    </style>
</head>
<body>

<!-- TradingView Chart Container -->
<div id="tv_chart_container"></div>

<!-- Liquidation Levels Box -->
<div id="liquidationLevelsBox">
    <h3>Liquidation Levels</h3>
    <div id="liquidationLevelsList">Loading liquidation levels...</div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    let liquidationLevels = [];

    // Fetch liquidation data from Binance API
    async function fetchLiquidationData() {
        try {
            const response = await fetch('https://fapi.binance.com/fapi/v1/liquidationOrders?symbol=BTCUSDT&limit=10');
            const data = await response.json();

            console.log('Liquidation Data:', data); // Debugging log

            if (data && Array.isArray(data)) {
                return data;
            } else {
                console.error('Invalid data format:', data);
                return [];
            }
        } catch (error) {
            console.error('Error fetching liquidation data:', error);
            return [];
        }
    }

    // Display liquidation levels in the box below the chart
    function displayLiquidationLevels() {
        const liquidationLevelsList = document.getElementById('liquidationLevelsList');
        liquidationLevelsList.innerHTML = ''; // Clear the list before adding new items

        if (liquidationLevels.length === 0) {
            liquidationLevelsList.innerHTML = 'No liquidation data available.';
        } else {
            liquidationLevels.forEach(level => {
                const levelElement = document.createElement('div');
                levelElement.className = 'liquidationLevel';

                const priceElement = document.createElement('p');
                priceElement.className = 'price';
                priceElement.innerHTML = `Price: $${level.price}`;

                const leverageElement = document.createElement('p');
                leverageElement.className = 'leverage';
                leverageElement.innerHTML = `Leverage: ${level.leverage}x`;

                const timestampElement = document.createElement('p');
                timestampElement.innerHTML = `Timestamp: ${new Date(level.time).toLocaleString()}`;

                levelElement.appendChild(priceElement);
                levelElement.appendChild(leverageElement);
                levelElement.appendChild(timestampElement);

                liquidationLevelsList.appendChild(levelElement);
            });
        }
    }

    window.onload = function () {
        // Initialize TradingView widget
        const widget = new TradingView.widget({
            container_id: "tv_chart_container",
            autosize: true,
            symbol: "BINANCE:BTCUSDT",  // Default symbol BTC/USDT on Binance
            interval: "60",  // 1-hour timeframe
            timezone: "Etc/UTC",
            theme: "dark",
            locale: "en",
            toolbar_bg: "#f1f3f6",
            enable_publishing: false,
            allow_symbol_change: true,
            save_image: false,
            studies: ["RSI@tv-basicstudies", "MACD@tv-basicstudies", "MAExp@tv-basicstudies"], // Indicators
            details: true,
            hotlist: true,
            calendar: true,
            withdateranges: true,
            hide_side_toolbar: false, // Side toolbar with basic tools
        });

        // Fetch liquidation data and display it
        fetchLiquidationData().then(data => {
            liquidationLevels = data.map((item) => ({
                price: item.price,  // Price where liquidation occurs
                leverage: item.leverage,
                time: item.time  // Timestamp of liquidation order
            }));
            displayLiquidationLevels();  // Update the box below the chart with liquidation levels
        });
    };
</script>

</body>
</html>