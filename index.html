const apiUrl = 'https://api.binance.com';

async function fetchCurrentPrice() {
  try {
    const response = await fetch(`${apiUrl}/api/v3/ticker/price?symbol=BTCUSDT`);
    const data = await response.json();
    return parseFloat(data.price);
  } catch (error) {
    console.error('Error fetching current price:', error);
  }
}

async function fetchOrderBook() {
  try {
    const response = await fetch(`${apiUrl}/api/v3/depth?symbol=BTCUSDT&limit=100`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching order book:', error);
  }
}

function calculateSum(orderBook, currentPrice, percentage) {
  const priceRangeLow = currentPrice - (currentPrice * (percentage / 100));
  const priceRangeHigh = currentPrice + (currentPrice * (percentage / 100));

  let bidsSum = 0;
  let asksSum = 0;

  // Sum bids
  orderBook.bids.forEach(([price, quantity]) => {
    price = parseFloat(price);
    quantity = parseFloat(quantity);
    if (price >= priceRangeLow && price <= currentPrice) {
      bidsSum += price * quantity;
    }
  });

  // Sum asks
  orderBook.asks.forEach(([price, quantity]) => {
    price = parseFloat(price);
    quantity = parseFloat(quantity);
    if (price <= priceRangeHigh && price >= currentPrice) {
      asksSum += price * quantity;
    }
  });

  return { bidsSum, asksSum };
}

async function updateOrderBook() {
  const percentage = parseFloat(document.getElementById('percentage').value);
  const currentPrice = await fetchCurrentPrice();
  const orderBook = await fetchOrderBook();

  if (currentPrice && orderBook) {
    const { bidsSum, asksSum } = calculateSum(orderBook, currentPrice, percentage);

    // Update the UI with the calculated sums
    document.getElementById('bids-sum').textContent = bidsSum.toFixed(2);
    document.getElementById('asks-sum').textContent = asksSum.toFixed(2);
  } else {
    document.getElementById('bids-sum').textContent = 'Error';
    document.getElementById('asks-sum').textContent = 'Error';
  }
}

// Initial load
updateOrderBook();