<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView with Binance Order Book</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #tv_chart_container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80vh; /* Set height for TradingView chart */
        }
        #orderBookContainer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20vh; /* Height for the order book chart */
            background-color: #121212;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        canvas {
            width: 95%;
            height: 90%;
        }
        label, input {
            margin: 10px;
            color: white;
        }
    </style>
</head>
<body>

<!-- TradingView Chart Container -->
<div id="tv_chart_container"></div>

<!-- Order Book Chart Container -->
<div id="orderBookContainer">
    <label for="minQty">Minimum Quantity (BTC):</label>
    <input type="number" id="minQty" value="0.001" step="0.001" min="0.000001">
    <canvas id="orderBookChart"></canvas>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    // Initialize TradingView chart
    window.onload = function () {
        new TradingView.widget({
            "container_id": "tv_chart_container",
            "autosize": true,
            "symbol": "BINANCE:BTCUSDT",  // Default symbol BTC/USDT on Binance
            "interval": "60",  // 1-hour timeframe
            "timezone": "Etc/UTC",
            "theme": "dark",  // Theme: dark mode
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "studies": [
                "RSI@tv-basicstudies",
                "MACD@tv-basicstudies",
                "MAExp@tv-basicstudies"
            ],
            "details": true,
            "hotlist": true,
            "calendar": true,
            "withdateranges": true,
            "hide_side_toolbar": false, // Show side toolbar with basic tools
        });
    };

    // Order book data variables
    const symbol = "BTCUSDT";
    let minQty = 0.001; // Default minimum quantity filter
    let orderBook = { bids: [], asks: [] }; // Order book data
    let orderBookChart;

    // Connect to Binance WebSocket for real-time depth updates
    const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@depth`);

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // Update the order book with the new data
        updateOrderBook(data.b, data.a);

        // Update the chart
        updateChart();
    };

    // Function to update the order book
    function updateOrderBook(bids, asks) {
        // Process bids
        bids.forEach(([price, quantity]) => {
            const priceNum = parseFloat(price);
            const quantityNum = parseFloat(quantity);

            if (quantityNum === 0 || priceNum < 1 || priceNum > 1000000 || quantityNum < minQty) {
                return; // Ignore invalid bids
            }

            const existing = orderBook.bids.find(order => order.price === priceNum);
            if (existing) {
                existing.quantity = quantityNum;
            } else {
                orderBook.bids.push({ price: priceNum, quantity: quantityNum });
            }
        });

        // Process asks
        asks.forEach(([price, quantity]) => {
            const priceNum = parseFloat(price);
            const quantityNum = parseFloat(quantity);

            if (quantityNum === 0 || priceNum < 1 || priceNum > 1000000 || quantityNum < minQty) {
                return; // Ignore invalid asks
            }

            const existing = orderBook.asks.find(order => order.price === priceNum);
            if (existing) {
                existing.quantity = quantityNum;
            } else {
                orderBook.asks.push({ price: priceNum, quantity: quantityNum });
            }
        });

        // Sort bids (descending) and asks (ascending)
        orderBook.bids.sort((a, b) => b.price - a.price);
        orderBook.asks.sort((a, b) => a.price - b.price);
    }

    // Initialize the order book chart
    function initializeChart() {
        const ctx = document.getElementById("orderBookChart").getContext("2d");

        orderBookChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [], // Will be updated dynamically
                datasets: [
                    {
                        label: "Bids",
                        data: [],
                        backgroundColor: "rgba(76, 175, 80, 0.7)", // Green for bids
                    },
                    {
                        label: "Asks",
                        data: [],
                        backgroundColor: "rgba(244, 67, 54, 0.7)", // Red for asks
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: "Price Levels (USDT)" }
                    },
                    y: {
                        title: { display: true, text: "Quantity (BTC)" }
                    }
                }
            }
        });
    }

    // Update the chart
    function updateChart() {
        const bidLabels = orderBook.bids.map(order => `$${order.price.toFixed(2)}`);
        const askLabels = orderBook.asks.map(order => `$${order.price.toFixed(2)}`);

        const bidQuantities = orderBook.bids.map(order => order.quantity);
        const askQuantities = orderBook.asks.map(order => order.quantity);

        orderBookChart.data.labels = [...bidLabels, ...askLabels];
        orderBookChart.data.datasets[0].data = bidQuantities;
        orderBookChart.data.datasets[1].data = askQuantities;

        orderBookChart.update();
    }

    // Event listener for the minimum quantity input
    document.getElementById("minQty").addEventListener("input", (event) => {
        minQty = parseFloat(event.target.value);

        // Re-filter and update the order book with the new minimum quantity
        orderBook.bids = orderBook.bids.filter(order => order.quantity >= minQty);
        orderBook.asks = orderBook.asks.filter(order => order.quantity >= minQty);

        // Update the chart
        updateChart();
    });

    // Initialize the order book chart
    initializeChart();
</script>

</body>
</html>