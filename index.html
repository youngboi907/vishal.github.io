<script>
    async function fetchMarketPrice() {
        const url = 'https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT';
        try {
            const response = await fetch(url);
            const data = await response.json();
            return parseFloat(data.price);
        } catch (error) {
            document.getElementById('order-book-error').innerText = `Error fetching market price: ${error.message}`;
            throw error;
        }
    }

    async function fetchOrderBook() {
        const url = 'https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=1000';
        try {
            const marketPrice = await fetchMarketPrice();
            const response = await fetch(url);
            const data = await response.json();

            if (data && data.bids && data.asks) {
                const filteredBids = filterByPercentage(data.bids, marketPrice, 1, 2.5, 'bids');
                const filteredAsks = filterByPercentage(data.asks, marketPrice, 1, 2.5, 'asks');
                displayOrderBook(filteredBids, filteredAsks);
            } else {
                throw new Error('Order book data is unavailable.');
            }
        } catch (error) {
            document.getElementById('order-book-error').innerText = `Error: ${error.message}`;
        }
    }

    function filterByPercentage(orders, marketPrice, minPercent, maxPercent, type) {
        return orders.filter(order => {
            const price = parseFloat(order[0]);
            const percentageDiff = ((price - marketPrice) / marketPrice) * 100;
            return type === 'bids'
                ? percentageDiff >= -maxPercent && percentageDiff <= -minPercent
                : percentageDiff >= minPercent && percentageDiff <= maxPercent;
        });
    }

    function displayOrderBook(bids, asks) {
        const tbody = document.getElementById('order-book').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        const maxEntries = Math.min(bids.length, asks.length);

        for (let i = 0; i < maxEntries; i++) {
            const bid = bids[i] || [];
            const ask = asks[i] || [];

            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${bid[0] || '-'}</td>
                <td>${bid[1] || '-'}</td>
                <td>${ask[0] || '-'}</td>
                <td>${ask[1] || '-'}</td>
            `;
        }
    }

    function startAutoRefresh(interval) {
        setInterval(fetchOrderBook, interval);
    }

    // Start fetching data when the page loads and set auto-refresh
    fetchOrderBook();
    startAutoRefresh(2000); // Auto-refresh every 2 seconds
</script>