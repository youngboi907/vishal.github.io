<!DOCTYPE html>
<html>
<head>
  <title>Binance Spot BTC/USDT Order Book</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Binance Spot BTC/USDT Order Book</h1>
  <div id="order-book-data">
    <h2>Order Book Data</h2>
    <p>Best Bid: <span id="best-bid"></span></p>
    <p>Best Ask: <span id="best-ask"></span></p>
    <p>Bid/Ask Ratio: <span id="bid-ask-ratio"></span></p>
  </div>

  <div id="charts">
    <h2>Order Book Depth Chart (1-10%)</h2>
    <canvas id="depth-chart"></canvas>
  </div>

  <script>
    async function fetchOrderBook() {
      try {
        const response = await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=100');
        const data = await response.json();

        const bids = data.bids.map(item => parseFloat(item[0]));
        const bidVolumes = data.bids.map(item => parseFloat(item[1]));
        const asks = data.asks.map(item => parseFloat(item[0]));
        const askVolumes = data.asks.map(item => parseFloat(item[1]));

        const bestBid = bids[0];
        const bestAsk = asks[0];

        // Calculate mid price
        const midPrice = (bestBid + bestAsk) / 2;

        // Calculate order book depth at 1% to 10% of mid price
        const depthPercentages = Array.from({length: 10}, (_, i) => (i + 1) / 100);
        const bidDepths = [];
        const askDepths = [];

        for (const percentage of depthPercentages) {
          const depthLevel = midPrice * percentage;
          let bidDepth = 0;
          let askDepth = 0;

          for (let i = 0; i < bids.length; i++) {
            if (bids[i][0] >= bestBid - depthLevel) {
              bidDepth += bids[i][1];
            } else {
              break; // No need to iterate further for bids
            }
          }

          for (let i = 0; i < asks.length; i++) {
            if (asks[i][0] <= bestAsk + depthLevel) {
              askDepth += asks[i][1];
            } else {
              break; // No need to iterate further for asks
            }
          }

          bidDepths.push(bidDepth);
          askDepths.push(askDepth);
        }

        // Calculate Bid/Ask Ratio (using top 10% depth as an example)
        const bidAskRatio = bidDepths[9] / askDepths[9]; 

        // Update UI with data
        document.getElementById('best-bid').textContent = bestBid;
        document.getElementById('best-ask').textContent = bestAsk;
        document.getElementById('bid-ask-ratio').textContent = bidAskRatio.toFixed(2);

        // Create Chart.js chart
        const ctx = document.getElementById('depth-chart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: depthPercentages.map(p => p * 100 + "%"), 
            datasets: [
              {
                label: 'Bid Depth',
                data: bidDepths,
                borderColor: 'green',
                fill: false,
              },
              {
                label: 'Ask Depth',
                data: askDepths,
                borderColor: 'red',
                fill: false,
              }
            ]
          },
          options: {
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Percentage from Mid Price'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Order Book Depth'
                }
              }
            }
          }
        });

      } catch (error) {
        console.error("Error fetching order book:", error);
        // Handle error gracefully (e.g., display error message to user)
      }
    }

    fetchOrderBook(); 
  </script>
</body>
</html>
