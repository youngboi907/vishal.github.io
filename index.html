<!DOCTYPE html>
<html>
<head>
  <title>Binance Spot BTC/USDT Order Book</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Binance Spot BTC/USDT Order Book</h1>
  <div id="order-book-data">
    <h2>Order Book Data</h2>
    <p>Best Bid: <span id="best-bid"></span></p>
    <p>Best Ask: <span id="best-ask"></span></p>
    <p>Bid/Ask Ratio (Top 5% Depth): <span id="bid-ask-ratio"></span></p>
  </div>

  <div id="charts">
    <h2>Order Book Depth Chart (Top 5%)</h2>
    <canvas id="depth-chart"></canvas>
  </div>

  <script>
    const wsUrl = 'wss://stream.binance.com:9443/ws/btcusdt@depth@100ms'; 
    let ws = new WebSocket(wsUrl);
    let chart;
    let bidDepth5 = 0;
    let askDepth5 = 0; 

    function calculateDepth(bids, asks, midPrice) {
      const depthPercentage = 0.05; // 5% 
      let bidDepth = 0;
      let askDepth = 0;

      for (let i = 0; i < bids.length; i++) {
        if (bids[i][0] >= midPrice * (1 - depthPercentage)) {
          bidDepth += bids[i][1];
        } else {
          break; 
        }
      }

      for (let i = 0; i < asks.length; i++) {
        if (asks[i][0] <= midPrice * (1 + depthPercentage)) {
          askDepth += asks[i][1];
        } else {
          break; 
        }
      }

      return { bidDepth, askDepth };
    }

    function updateChart(bidDepth, askDepth) {
      if (chart) {
        chart.data.datasets[0].data = [bidDepth]; 
        chart.data.datasets[1].data = [askDepth]; 
        chart.update();
      }
    }

    ws.onopen = function() {
      console.log('WebSocket connection opened.');
    };

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const bids = data.b.map(item => parseFloat(item[0]));
      const bidVolumes = data.b.map(item => parseFloat(item[1]));
      const asks = data.a.map(item => parseFloat(item[0]));
      const askVolumes = data.a.map(item => parseFloat(item[1]));

      const bestBid = bids[0];
      const bestAsk = asks[0];

      // Calculate mid price
      const midPrice = (bestBid + bestAsk) / 2;

      // Calculate top 5% depth
      const { bidDepth: newBidDepth, askDepth: newAskDepth } = calculateDepth(bids, asks, midPrice);
      bidDepth5 = newBidDepth;
      askDepth5 = newAskDepth;

      // Calculate Bid/Ask Ratio 
      const bidAskRatio = bidDepth5 / askDepth5; 

      // Update UI
      document.getElementById('best-bid').textContent = bestBid;
      document.getElementById('best-ask').textContent = bestAsk;
      document.getElementById('bid-ask-ratio').textContent = bidAskRatio.toFixed(2);

      // Update chart
      updateChart(bidDepth5, askDepth5); 
    };

    ws.onclose = function() {
      console.log('WebSocket connection closed.');
      // Attempt to reconnect (optional)
    };

    // Create Chart.js chart
    const ctx = document.getElementById('depth-chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Bid Depth (Top 5%)', 'Ask Depth (Top 5%)'],
        datasets: [
          {
            label: 'Depth',
            data: [], 
            backgroundColor: ['green', 'red'],
          }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

  </script>
</body>
</html>
