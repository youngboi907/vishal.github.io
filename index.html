<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }

        #tv_chart_container {
            width: 100%;
            height: 60vh;
            margin-bottom: 20px;
        }

        .chart-container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
        }

        #orderBookChart, #oiChart {
            background-color: #1e1e1e;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 8px;
        }

        input[type="number"] {
            padding: 5px;
            border: none;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin: 10px 0 5px;
        }
    </style>
</head>
<body>
    <!-- TradingView Chart -->
    <div id="tv_chart_container"></div>

    <!-- Order Book Filter -->
    <div class="chart-container">
        <h2>Order Book Filter</h2>
        <label for="minQty">Minimum Quantity (BTC):</label>
        <input type="number" id="minQty" value="0.001" step="0.001" min="0.000001">
        <canvas id="orderBookChart"></canvas>
    </div>

    <!-- Open Interest Chart -->
    <div class="chart-container">
        <h2>Open Interest</h2>
        <canvas id="oiChart"></canvas>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // TradingView Chart Full Functionality
        new TradingView.widget({
            container_id: "tv_chart_container",
            autosize: true,
            symbol: "BINANCE:BTCUSDT",
            interval: "60",
            timezone: "Etc/UTC",
            theme: "dark",
            locale: "en",
            toolbar_bg: "#f1f3f6",
            enable_publishing: false,
            allow_symbol_change: true,
            hide_side_toolbar: false,
            studies: ["EMA@tv-basicstudies"],
            drawings_access: { type: "all", tools: ["Regression Trend", "Fibonacci Retracement"] },
        });

        // Order Book Filter
        const symbol = "BTCUSDT";
        let minQty = 0.001;
        let orderBook = { bids: [], asks: [] };
        let orderBookChart;

        const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@depth`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateOrderBook(data.b, data.a);
            updateOrderBookChart();
        };

        function updateOrderBook(bids, asks) {
            orderBook.bids = bids
                .map(([price, qty]) => ({ price: parseFloat(price), qty: parseFloat(qty) }))
                .filter(order => order.qty >= minQty);
            orderBook.asks = asks
                .map(([price, qty]) => ({ price: parseFloat(price), qty: parseFloat(qty) }))
                .filter(order => order.qty >= minQty);
        }

        function initializeOrderBookChart() {
            const ctx = document.getElementById("orderBookChart").getContext("2d");
            orderBookChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [],
                    datasets: [
                        { label: "Bids", data: [], backgroundColor: "rgba(76, 175, 80, 0.7)" },
                        { label: "Asks", data: [], backgroundColor: "rgba(244, 67, 54, 0.7)" },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: "Price Levels (USDT)" } },
                        y: { title: { display: true, text: "Quantity (BTC)" } },
                    },
                },
            });
        }

        function updateOrderBookChart() {
            const bids = orderBook.bids.slice(0, 10);
            const asks = orderBook.asks.slice(0, 10);
            const labels = [...bids.map(bid => `$${bid.price}`), ...asks.map(ask => `$${ask.price}`)];
            const bidData = bids.map(bid => bid.qty);
            const askData = asks.map(ask => ask.qty);

            orderBookChart.data.labels = labels;
            orderBookChart.data.datasets[0].data = bidData;
            orderBookChart.data.datasets[1].data = askData;
            orderBookChart.update();
        }

        document.getElementById("minQty").addEventListener("input", (e) => {
            minQty = parseFloat(e.target.value) || 0.001;
        });

        initializeOrderBookChart();

        // Open Interest Chart
        function initializeOIChart() {
            const ctx = document.getElementById("oiChart").getContext("2d");
            const oiChart = new Chart(ctx, {
                type: "candlestick",
                data: {
                    datasets: [{
                        label: "Open Interest",
                        data: [],
                        borderColor: "rgba(33, 150, 243, 1)",
                        backgroundColor: "rgba(33, 150, 243, 0.2)",
                    }],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: "Timestamp" } },
                        y: { title: { display: true, text: "Open Interest" } },
                    },
                },
            });

            function updateOIChart(data) {
                const formattedData = data.map(point => ({
                    x: new Date(point.timestamp),
                    o: point.open,
                    h: point.high,
                    l: point.low,
                    c: point.close,
                }));

                oiChart.data.labels = formattedData.map(d => d.x);
                oiChart.data.datasets[0].data = formattedData;
                oiChart.update();
            }

            setInterval(() => {
                const simulatedData = Array.from({ length: 12 }, (_, i) => ({
                    timestamp: Date.now() - i * 300000,
                    open: Math.random() * 1000 + 5000,
                    high: Math.random() * 1000 + 5500,
                    low: Math.random() * 1000 + 4500,
                    close: Math.random() * 1000 + 5000,
                })).reverse();
                updateOIChart(simulatedData);
            }, 1000);
        }

        initializeOIChart();
    </script>
</body>
</html>